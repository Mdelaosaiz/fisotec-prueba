<!doctype html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" type="text/css">
  <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js" type="text/javascript"></script>
  <script src="https://unpkg.com/esri-leaflet@2.1.4/dist/esri-leaflet.js"></script>
  <script src="./js/leaflet.ajax.min.js" type="text/javascript"></script>
  <style>
    html, body {
      height: 100%;
      width: 100%;
      margin: 0
    }
    #mapa {
      height: 100%;
      width: 100%;
    }
    .pop{
      width: 25%;
      top:5vh;
      right: 2vh;
      padding: 15px;
      position:absolute;
      visibility:hidden;
      z-index: 500;
      display:flex;
      flex-direction: column;
      text-align: start;
      border:3px solid rgb(18, 105, 187);
      background: linear-gradient(to bottom, rgb(169, 209, 236), white);;
      border-radius: 15px;
      
    }
    label{
      margin-bottom: 5px;
    }
    input{
      width: 90%;
      margin-bottom: 5px;
    }
    .tsunami{
      width: 15px;
      height: 15px;
      margin-bottom: 5px;
    }
    .alert{
      display: flex;
      flex-direction:row;
    }
    .color{
      width: 15px;
      height: 15px;
      margin-left: 5px;
      border: 1px solid black;
      background: rgb(250, 250, 250);
    }
  </style>
  <title>Prueba FISOTEC</title>
</head>

<body>
    <div id="mapa"></div>
    <form action="https://formspree.io/xdowgjrn" method="post"></form>
    <div class="pop">
      <h1 class="title">Información del evento</h1>
      <fieldset>
        <legend class="type-legend"> General: </legend>
         <label for="type">Tipo: </label>
         <input 
           type="text" 
           class="type" 
           name="type" 
           disabled
         />
         <label for="tsunami">Tsunamis: </label>
         <input 
           type="checkbox"
           class="tsunami"
           name="tsunami"
           disabled
          /><br>
      </fieldset>
      <fieldset>
        <legend class="place-legend"> Localización: </legend>
         <label for="place">Ciudad: </label>
         <input 
           type="text" 
           class="place" 
           name="place" 
           disabled
         />
         <label for="coord"> Coordenadas: </label>
         <input 
           type="text" 
           class="coord" 
           name="coord" 
           disabled
         />
      </fieldset>
      <fieldset>
        <legend class="level-legend">Nivel del evento: </legend>
        <label for="magnitude">Magnitud: </label>
        <input 
         type="text"
         class="magnitude"
         name="magnitude"
         disabled
        />
        <div class="alert">
         <label for="alert">Alerta: </label>
         <div class="color"></div>    
        </div>   
      </fieldset>
    </div>
  

  <script type="text/javascript">
    var mapa = L.map("mapa", {
      center: [0, 0],
      zoom: 2
    });

    var capaOrtoFoto = L.esri.basemapLayer("Imagery");
    capaOrtoFoto.addTo(mapa);

    var url = "https://earthquake.usgs.gov/earthquakes/feed/v1.0/summary/all_month.geojson";
    const pop = document.querySelector(".pop");
    const type = document.querySelector(".type");
    const place = document.querySelector(".place");
    const coordinates = document.querySelector(".coord");
    const magnitude = document.querySelector(".magnitude");
    const tsunami = document.querySelector(".tsunami");
    const evAlert = document.querySelector(".color");

    L.Util.ajax(url).then(
      function (datosGeoJOSN) {
        var capaTerremotos = L.geoJSON(datosGeoJOSN, {
          pointToLayer: function (entidad, latlng) {
            return L.circleMarker(latlng);
          },
          style: function (entidad) {
            var magnitud = entidad.properties.mag;
            var colorTerremoto;
            if (magnitud > 6) {
              colorTerremoto = "rgba(255, 0, 0)"
            } else if (magnitud <= 6 && magnitud > 5) {
              colorTerremoto = "rgba(255, 255, 0)"
            } else if (magnitud <= 5 && magnitud > 4) {
              colorTerremoto = "rgba(0, 255, 255)"
            } else {
              colorTerremoto = "rgba(0, 0, 255)"
            }

            var miEstilo = {
              radius: 1.6 ** magnitud,
              fillColor: colorTerremoto,
              fillOpacity: 0.4,
              color: "rgba(0, 0, 0, 0.7)",
              weight: 1
            };

            return miEstilo
          }
        });
        
        capaTerremotos.bindPopup(function (entidad) {
            return 'Magnitud: ' + entidad.feature.properties.mag
        });
        
        function popUpOpen (e){
          // Rellena los datos del HTML con los recogidos por el fetch
          pop.style.visibility = "visible";
          type.value = e.popup._source.feature.properties.type;
          place.value = e.popup._source.feature.properties.place;
          coordinates.value = e.popup._source.feature.geometry.coordinates;
          magnitude.value = e.popup._source.feature.properties.mag + " puntos.";
          evAlert.value = e.popup._source.feature.properties.alert;

          // Se pone el check de los tsunamis en true cuando haya un valor de 1
          if(e.popup._source.feature.properties.tsunami === 1){
             tsunami.checked = true;
          }else{
            tsunami.checked = false;
          }
          
          // Según el nivel de alerta del evento, se acambia el fondo del input.

          if(e.popup._source.feature.properties.alert === "green"){
            evAlert.style.backgroundColor = 'rgb(18, 190, 47)';
          } else if(e.popup._source.feature.properties.alert === "yellow"){
            evAlert.style.backgroundColor = 'rgb(246, 250, 6)';
          }else if(e.popup._source.feature.properties.alert === "orange"){
            evAlert.style.backgroundColor = 'rgb(247, 149, 3)';
          }else if(e.popup._source.feature.properties.alert === "red"){
            evAlert.style.backgroundColor = 'rgb(250, 2, 2)';
          } else if(e.popup._source.feature.properties.alert === null){
            evAlert.style.backgroundColor = 'rgb(255, 255, 255)'
          } 
          
        }
        function popUpClose (e){
          pop.style.visibility = "hidden";
          
        }
        
        capaTerremotos.addEventListener("popupopen", popUpOpen);

        capaTerremotos.addEventListener("popupclose", popUpClose);


        capaTerremotos.addTo(mapa);
      });
      
      //Crea el botón de información
      L.Control.Button = L.Control.extend({
          onAdd: function(map) {
           const button = L.DomUtil.create('button');
           button.style.width = '60px';
           button.style.height = '30px';
           button.style.cursor = 'pointer';
           button.style.borderRadius = '15px';
           button.innerHTML = 'Todo';
           return button;
          },
          onRemove: function(map) {
           // No hay nada porque no queremos que desaparezca.
          }
        });

        L.control.button = function(opts) {
         return new L.Control.Button(opts);
        }

        L.control.button({ position: 'topleft' }).addTo(mapa);
      
      //Añade un pequeño detalle de la librería.
      L.Control.Watermark = L.Control.extend({
          onAdd: function(map) {
           var img = L.DomUtil.create('img');
           img.src = 'js/images/leaflet.png';
           img.style.width = '50px';
           return img;
          },
          onRemove: function(map) {
          }
        });

        L.control.watermark = function(opts) {
         return new L.Control.Watermark(opts);
        }

        L.control.watermark({ position: 'bottomleft' }).addTo(mapa);
  </script>
</body>

</html>